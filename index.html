<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    html,
    body {
      max-width: 100%;
      overflow-x: hidden;
    }

    #mainContent {
      overflow-x: hidden;
    }

    .scroll-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    .table-container {
      width: 100%;
      table-layout: auto;
    }

    body {
      font-family: "Cairo", sans-serif;
    }

    .ltr {
      direction: ltr;
      text-align: left;
    }

    .rtl {
      direction: rtl;
      text-align: right;
    }

    .active-link {
      background-color: #f9a8d4;
      color: #831843;
      font-weight: bold;
      transition: all 0.3s ease;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">
  <!-- Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div id="backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="closeSidebar()"></div>

  <!-- Ø²Ø± Ø§Ù„Ù‡Ø§Ù…Ø¨Ø±Ø¬Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <button id="toggleSidebar"
    class="md:hidden fixed top-4 right-4 z-50 bg-pink-600 text-white p-2 rounded-full shadow-lg">
    <i data-lucide="menu"></i>
  </button>

  <div class="flex flex-col md:flex-row min-h-screen w-full">
    <!-- Sidebar -->
    <aside id="sidebar"
      class="fixed md:relative top-0 right-0 h-full w-64 bg-white dark:bg-gray-800 p-4 space-y-3 border-r transform transition-transform duration-300 md:translate-x-0 translate-x-full z-40">
      <!-- Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
      <div class="flex justify-end md:hidden mb-4">
        <button onclick="closeSidebar()" class="text-gray-500 hover:text-pink-600 text-xl">
          <i data-lucide="x"></i>
        </button>
      </div>

      <h2 class="text-xl font-bold text-pink-600 mb-4" id="sidebarTitle">
        Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </h2>
      <nav class="space-y-2">
        <button onclick="loadPage('home')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="home"></i><span id="homeLabel" class="truncate">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button onclick="loadPage('attendance')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="calendar"></i><span id="attendanceLabel" class="truncate">Ø§Ù„Ø­Ø¶ÙˆØ± Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</span>
        </button>
        <button onclick="loadPage('leave')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="plane"></i><span id="leaveLabel" class="truncate">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø¬Ø§Ø²Ø©</span>
        </button>
        <button onclick="loadPage('honda')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="settings"></i><span id="hondaLabel" class="truncate">Ø§Ù„ØªØ³ÙƒÙŠÙ†</span>
        </button>
        <button onclick="loadPage('stock')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="box"></i><span id="stockLabel" class="truncate">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</span>
        </button>
        <button onclick="loadPage('add-employee')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="user-plus"></i><span id="addEmpLabel" class="truncate">Ø£Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</span>
        </button>
        <button onclick="loadPage('view-staff')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="users"></i><span id="viewStaffLabel" class="truncate">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
        </button>
        <button onclick="loadPage('settings')" class="w-full flex items-center gap-2 p-2 rounded hover:bg-pink-100">
          <i data-lucide="cog"></i><span id="settingsLabel" class="truncate">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-grow p-4 w-full" id="mainContent">
      <header class="flex items-center justify-between mb-6 mt-16 md:mt-0">
        <h1 id="pageTitle" class="text-2xl font-bold text-pink-700">
          ğŸ“Š Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </h1>
      </header>
      <section id="pageContent">
        <p class="text-gray-600 dark:text-gray-300">
          Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
        </p>
      </section>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const toggleButton = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("backdrop");

    toggleButton.addEventListener("click", () => {
      sidebar.classList.remove("translate-x-full", "-translate-x-full");
      sidebar.classList.add("md:translate-x-0");
      backdrop.classList.remove("hidden");
      toggleButton.classList.add("hidden");
    });

    function closeSidebar() {
      const lang = localStorage.getItem("lang") || "ar";
      if (lang === "en") {
        sidebar.classList.add("-translate-x-full");
      } else {
        sidebar.classList.add("translate-x-full");
      }

      backdrop.classList.add("hidden");
      toggleButton.classList.remove("hidden");
    }

    const loadingMessages = {
      ar: (page) =>
        `ğŸ“„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© "${translations.ar.titles[page] || page}"`,
      en: (page) =>
        `ğŸ“„ Loading page "${translations.en.titles[page] || page}"`,
    };

    const translations = {
      ar: {
        sidebarTitle: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        homeLabel: "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        attendanceLabel: "Ø§Ù„Ø­Ø¶ÙˆØ± Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù",
        leaveLabel: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø¬Ø§Ø²Ø©",
        hondaLabel: "Ø§Ù„ØªØ³ÙƒÙŠÙ†",
        stockLabel: "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†",
        addEmpLabel: "Ø£Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù",
        viewStaffLabel: "Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
        settingsLabel: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        titles: {
          home: "ğŸ“Š Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
          attendance: "ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ± Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù",
          leave: "ğŸ“ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø¬Ø§Ø²Ø©",
          honda: "ğŸ”§ Ø§Ù„ØªØ³ÙƒÙŠÙ†",
          stock: "ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†",
          "add-employee": "ğŸ‘¤ Ø£Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù",
          "view-staff": "ğŸ‘¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
          settings: "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        },
        content: {
          home: "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….",
          attendance:
            "<p class='text-gray-700 dark:text-gray-200'>Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØªØ§Ø¨Ø¹ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</p>",
          leave:
            "<p class='text-gray-700 dark:text-gray-200'>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§.</p>",
          honda:
            "<p class='text-gray-700 dark:text-gray-200'>Ù‚Ø³Ù… Ø§Ù„ØªØ³ÙƒÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª.</p>",
          stock:
            "<p class='text-gray-700 dark:text-gray-200'>Ø£Ø¶Ù Ø£Ùˆ ØªØ§Ø¨Ø¹ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª.</p>",
          "add-employee":
            "<p class='text-gray-700 dark:text-gray-200'>Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯.</p>",
          "view-staff":
            "<p class='text-gray-700 dark:text-gray-200'>Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØ¹Ø±Ø¶ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</p>",
          settings: `<div class='flex gap-4'><select onchange="changeLang(this.value)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"><option value='ar'>ğŸ‡ªğŸ‡¬ Ø¹Ø±Ø¨ÙŠ</option><option value='en'>ğŸ‡ºğŸ‡¸ English</option></select></div>`,
        },
        filters: {
          allOffices: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨",
          downloadCSV: "ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel",
          viewImage: "ğŸ“· Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©",
          search: "ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...",
        },

        tableValues: {
          Ø´Ø¨Ø±Ø§: "Downtown",
          Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†: "Mohandsen",
          "Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³": "Gesr elsuiz",
          Ø­Ø¶ÙˆØ±: "Login",
          Ø§Ù†ØµØ±Ø§Ù: "Log out",
        },
      },
      en: {
        sidebarTitle: "Dashboard",
        homeLabel: "Home",
        attendanceLabel: "Attendance",
        leaveLabel: "Leave requests",
        hondaLabel: "Honda start",
        stockLabel: "Add to stock",
        addEmpLabel: "Add an employee",
        viewStaffLabel: "Staff View",
        settingsLabel: "Settings",
        titles: {
          home: "ğŸ“Š Home",
          attendance: "ğŸ“… Attendance",
          leave: "ğŸ“ Leave requests",
          honda: "ğŸ”§ Honda start",
          stock: "ğŸ“¦ Add to stock",
          "add-employee": "ğŸ‘¤ Add an employee",
          "view-staff": "ğŸ‘¥ Staff View",
          settings: "âš™ï¸ Settings",
        },
        content: {
          home: "Welcome to the dashboard.",
          attendance:
            "<p class='text-gray-700 dark:text-gray-200'>Here you can track employee attendance.</p>",
          leave:
            "<p class='text-gray-700 dark:text-gray-200'>Leave requests will appear here.</p>",
          honda:
            "<p class='text-gray-700 dark:text-gray-200'>Honda generator assignment section.</p>",
          stock:
            "<p class='text-gray-700 dark:text-gray-200'>Add or track equipment stock.</p>",
          "add-employee":
            "<p class='text-gray-700 dark:text-gray-200'>Form to add a new employee.</p>",
          "view-staff":
            "<p class='text-gray-700 dark:text-gray-200'>View all staff data here.</p>",
          settings: `<div class='flex gap-4'><select onchange="changeLang(this.value)" class="p-2 rounded bg-gray-100 dark:bg-gray-700 text-sm"><option value='ar'>ğŸ‡ªğŸ‡¬ Arabic</option><option value='en' selected>ğŸ‡ºğŸ‡¸ English</option></select></div>`,
        },
        filters: {
          allOffices: "All offices",
        },
        tableValues: {
          Ø´Ø¨Ø±Ø§: "Downtown",
          Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†: "Mohandsen",
          "Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³": "Gesr elsuiz",
          Ø­Ø¶ÙˆØ±: "Login",
          Ø§Ù†ØµØ±Ø§Ù: "Log out",
        },

        tableHeaders: {
          Ø§Ù„ÙˆÙ‚Øª: ["Date", "Time"],
          Ø§Ù„Ø§Ø³Ù…: "Name",
          Ø§Ù„Ù…ÙƒØªØ¨: "Office",
          Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: "Procedure",
          "Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ (Latitude)": "Latitude",
          "Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Longitude)": "Longitude",
          "Ø§Ù„ØµÙˆØ±Ø© (Ø±Ø§Ø¨Ø·)": "Image (link)",
          "Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±": "Reason for early departure",
        },
        tableValues: {
          Ø­Ø¶ÙˆØ±: "Login",
          Ø§Ù†ØµØ±Ø§Ù: "Log out",
          Ø´Ø¨Ø±Ø§: "Downtown",
          Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†: "Mohandsen",
          "Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³": "Gesr elsuiz",
        },
        filters: {
          allOffices: "ğŸ“ All offices",
          downloadCSV: "ğŸ’¾ Download the Excel file",
          viewImage: "ğŸ“· View image",
          search: "ğŸ” Search by name...",
        },
      },
    };

    let currentLang = localStorage.getItem("lang") || "ar";

    function changeLang(lang) {
      localStorage.setItem("lang", lang);
      currentLang = lang;
      document.documentElement.setAttribute("lang", lang);
      document.documentElement.setAttribute(
        "dir",
        lang === "ar" ? "rtl" : "ltr"
      );
      document.body.classList.toggle("rtl", lang === "ar");
      document.body.classList.toggle("ltr", lang === "en");

      const toggleBtn = document.getElementById("toggleSidebar");
      const sidebar = document.getElementById("sidebar");

      // Ø§Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      sidebar.classList.remove(
        "left-0",
        "right-0",
        "translate-x-full",
        "-translate-x-full"
      );

      // ØºÙŠÙ‘Ø± Ù…ÙƒØ§Ù† Ø²Ø± Ø§Ù„Ù‡Ø§Ù…Ø¨Ø±Ø¬Ø±
      if (lang === "en") {
        toggleBtn.classList.remove("right-4");
        toggleBtn.classList.add("left-4");

        sidebar.classList.add("left-0", "-translate-x-full");
      } else {
        toggleBtn.classList.remove("left-4");
        toggleBtn.classList.add("right-4");

        sidebar.classList.add("right-0", "translate-x-full");
      }

      Object.keys(translations[lang]).forEach((id) => {
        const el = document.getElementById(id);
        if (el && typeof translations[lang][id] === "string") {
          el.textContent = translations[lang][id];
        }
      });

      const activePage =
        document.querySelector("#pageContent").getAttribute("data-page") ||
        "home";
      updatePageContent(activePage);

      if (
        document.querySelector("#pageContent").getAttribute("data-page") ===
        "attendance"
      ) {
        fetchAttendanceData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
      }
    }

    function loadPage(page) {
      updatePageContent(page);

      // Ø´ÙŠÙ„ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      document
        .querySelectorAll("nav button")
        .forEach((btn) => btn.classList.remove("active-link"));

      // Ø­Ø¯Ø¯ Ø§Ù„Ø²Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ®Øµ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const labelId = page.replace("-", "") + "Label";
      const labelEl = document.getElementById(labelId);
      if (labelEl) {
        labelEl.parentElement.classList.add("active-link");
      }

      if (window.innerWidth < 768) {
        closeSidebar();
      }
    }

    function updatePageContent(page) {
      const title = translations[currentLang].titles[page] || page;
      let content = "";

      if (page === "attendance") {
        const loadingMsg =
          currentLang === "ar" ? "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..." : "â³ Loading data...";
        content = `<div id="attendanceTable" class="py-4 text-sm text-gray-800 dark:text-white">${loadingMsg}</div>`;
      } else if (page === "honda") {
        content = `<div class='py-4'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;
      } else if (page === "home") {
        content = `
    <section class='space-y-8 px-4' id='dashboardAnalysis'>
      <div class='text-gray-700 dark:text-gray-200'>ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </section>
  `;
      }
      else {
        content =
          translations[currentLang].content[page] ||
          `<div class='text-gray-500 dark:text-gray-300'>${loadingMessages[currentLang](page)}</div>`;
      }



      document.getElementById("pageTitle").textContent = title;
      const contentElement = document.getElementById("pageContent");
      contentElement.innerHTML = `<div class='py-4'>${content}</div>`;
      if (page === "home") {
        loadDashboardAnalysis();
      }

      contentElement.setAttribute("data-page", page);

      // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
      if (page === "attendance") fetchAttendanceData();

      if (page === "honda") {
        previousData = []; // Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ù„Ø´Ø§Ù† ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…Ø±Ø©
        fetchHondaData();  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        clearInterval(window.hondaInterval); // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ù‚Ø¯ÙŠÙ…
        window.hondaInterval = setInterval(fetchHondaData, 10000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
      } else {
        clearInterval(window.hondaInterval); // Ù„Ùˆ Ø®Ø±Ø¬ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªØ³ÙƒÙŠÙ† ÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«
      }
    }


    const techniciansMap = {
      "Ù…Ø­Ù…Ø¯ Ø¹ØµØ§Ù… Ø£Ù†ÙˆØ± Ø­Ø³Ù†": "Mohamed Essam Anwar Hassan",
      "Ø¹Ù„Ù‰ Ø§Ø­Ù…Ø¯ Ø·Ù†Ø·Ø§ÙˆÙ‰ Ù…Ù†ØµÙˆØ±": "Ali Ahmed Tantawi Mansour",
      "Ø´Ø§Ø¯Ù‰ Ø±Ø£ÙØª Ø±ÙØ§Ø¹ÙŠ Ù…Ø­Ù…ÙˆØ¯ ØµØ§Ù„Ø­": "Shady Raafat Refai Mahmoud Saleh",
      "Ù…Ø­Ù…Ø¯ Ø­Ø³ÙŠÙ† Ù…Ø­Ù…Ø¯ Ø¹Ø§Ù…Ø±": "Mohamed Hussein Mohamed Amer",
      "Ù…ØµØ·ÙÙŠ Ø³Ø§Ù…Ù‰ Ù…ØµØ·ÙÙŠ": "Mustafa Sami Mustafa Daoud",
      "Ù…ØµØ·ÙÙ‰ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ù†Ø¹ÙŠÙ… Ø¹Ù…Ø§Ø±": "Mustafa Mahmoud Abdel Naeem Ammar",
      "Ù…Ø­Ù…ÙˆØ¯ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ù„Ø¨Ù„ÙŠÙ‡Ù‰":
        "Mahmoud Mohamed Abdel Hamid Al-Buleihi",
      "Ø³Ø¹ÙŠØ¯ Ø­Ø³ÙŠÙ† Ø¹Ù„Ù‰": "Saeed Hussein Ali",
      "Ø±Ø§ÙØª Ø³ÙŠØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø´ÙƒÙˆØ±": "Raafat Sayed Abdel Shakoor Abdel Khaleq",
      "Ø¨Ø§Ø³Ù… Ù†Ø´Ø£Øª ØµØ§Ù„Ø­": "Bassem Nashat Saleh",
      "Ø§Ø¨Ø§Ù†ÙˆØ¨ Ø²ØºÙ„ÙˆÙ„ Ø¹Ø§Ø²Ø± Ù…ÙŠØ®Ø§Ø¦ÙŠÙ„": "Abanoub Zaghloul Azer Mikhail",
      "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ù‡ ØªÙˆÙÙŠÙ‚ Ø§Ø¨ÙˆØ²ÙŠØ¯": "Mohamed Abdo Tawfik Abu Zeid",
      "Ù…Ø¬Ø¯Ù‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†":
        "Magdy Abdel Hamid Ahmed Abdel Rahman",
      "Ø£Ø­Ù…Ø¯ Ø¹Ø²Øª Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…": "Ahmed Ezzat Abdel Aziz Ibrahim",
      "Ø§Ø­Ù…Ø¯ Ø¹Ù„Ù‰ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ø§ÙØ¸ Ù…Ø±Ø³Ù‰": "Ahmed Ali Abdel Hafez Morsi",
      "Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ø­Ù…Ø¯": "Mohamed Ahmed Abdel Hamid Ahmed",
      "Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø­Ø³Ù†Ù‰ Ø¹Ø¨Ø¯Ù‡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…": "Ibrahim Hosni Abdo Ibrahim",
      "ÙÙˆØ²Ù‰ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø´Ø§ÙÙ‰ Ù…Ø·ÙŠØ´": "Fawzy Mohamed Abdel Shafi Matish",
      "Ø­Ø³ÙŠÙ† Ù‡Ù„Ø§Ù„ Ø­Ø³ÙŠÙ† Ù…Ø­Ù…Ø¯": "Hussein Hilal Hussein Mohamed",
      "Ø¹Ù„Ù‰ Ø­Ø³Ù† Ø¹Ù„Ù‰": "Ali Hassan Ali",
      "Ø¨Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù† Ù‚Ø·Ø¨ Ø­Ø³Ù†": "Bilal Ramadan Qutb Hassan",
      "Ù‡Ø§Ù†Ù‰ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„ÙØªØ§Ø­": "Hani Abdel Hamid Ahmed Abdel Fattah",
      "Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯": "Mohamed Ahmed Ahmed Mohamed Ahmed",
      "Ù†Ø§Ø¯Ø± Ù†Ø¬ÙŠØ¨ Ø­Ù†Ø§ ÙŠØ¹Ù‚ÙˆØ¨": "Nader Naguib Hanna Yacoub",
      "Ø§ÙŠÙ…Ù† Ø¬Ù…Ø§Ù„ Ø¬Ø±Ø¬Ø³ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…": "Ayman Gamal Girgis Ibrahim",
      "Ù‡ÙŠØ«Ù… Ù…ØµØ·ÙÙ‰ Ù…ØµØ·ÙÙ‰ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ": "Haitham Mustafa Mustafa Abdel Latif",
    };

    function fetchAttendanceData() {
      const sheetURL =
        "https://script.google.com/macros/s/AKfycby5QdbFnpkhnBFkl5el6B2rflE1HcCHTMzV2hERMhbll4veiAESm4ElsQf7Bey3sDzUAQ/exec";

      fetch(sheetURL)
        .then((res) => res.json())
        .then((data) => {
          const offices = ["Ø´Ø¨Ø±Ø§", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", "Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³"];
          let officeOptions = `<option value="">${translations[currentLang].filters.allOffices}</option>`;
          offices.forEach((o) => {
            const translatedOffice =
              translations[currentLang].tableValues?.[o] || o;
            officeOptions += `<option value="${o}">${translatedOffice}</option>`;
          });

          let filters = `
<div class="mb-4 flex flex-col md:flex-row items-center gap-4 md:gap-2 justify-start flex-wrap">

    <!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ -->
    <input type="text" id="searchInput" placeholder="${translations[currentLang].filters.search}"
" 
      class="w-full md:w-1/3 p-2 border rounded shadow text-sm text-gray-800 dark:text-white dark:bg-gray-800 dark:border-gray-600">
    <!-- ğŸ¢ Ø§Ù„ÙÙ„ØªØ± Ø¨Ø§Ù„Ù…ÙƒØªØ¨ -->
    
   <select id="officeFilter" 
  class="w-full md:w-1/4 p-2 border rounded shadow text-sm text-gray-800 dark:text-white dark:bg-gray-800 dark:border-gray-600">
  ${officeOptions}
</select>


    <!-- ğŸ’¾ Ø²Ø± ØªØ­Ù…ÙŠÙ„ CSV -->
    <button onclick="exportTableToCSV('attendance.csv')" 
      class="p-2 bg-pink-600 text-white rounded hover:bg-pink-700 text-sm shadow">
${translations[currentLang].filters.downloadCSV}
    </button>

  </div>
`;

          const container = document.getElementById("attendanceTable");
          if (!data || data.length === 0) {
            container.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹.";
            return;
          }

          let table = `
<div class="w-full overflow-x-auto border rounded shadow min-h-[400px] h-[80vh]">

<table class="min-w-max w-full bg-white dark:bg-gray-800 text-sm text-right border border-gray-300 dark:border-gray-700">
      <thead class="bg-pink-600 text-white sticky top-0 z-10">
        <tr>`;

          // ğŸ§  Ø§Ù„Ù‡ÙŠØ¯Ø±: Ù„Ùˆ ÙÙŠÙ‡ Ø¹Ù…ÙˆØ¯ ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ® Ù†Ù‚Ø³Ù…Ù‡ Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†
          Object.keys(data[0]).forEach((key) => {
            if (
              key === "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª" ||
              key.toLowerCase().includes("time")
            ) {
              const headers = translations[currentLang].tableHeaders[key] || [
                "Date",
                "Time",
              ];
              table += `<th class="px-4 py-2 text-center">ğŸ“… ${headers[0]}</th>`;
              table += `<th class="px-4 py-2 text-center">â° ${headers[1]}</th>`;
            } else {
              const translated =
                translations[currentLang].tableHeaders?.[key] || key;
              table += `<th class="px-4 py-2 text-center">${translated}</th>`;
            }
          });

          table += `</tr></thead><tbody class="text-gray-700 dark:text-gray-200">`;

          // ğŸ§  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          data.forEach((row) => {
            const officeName = row["Ø§Ù„Ù…ÙƒØªØ¨"];
            table += `<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-pink-50 dark:hover:bg-gray-700" data-office="${officeName}">`;

            Object.entries(row).forEach(([key, val]) => {
              if (
                key === "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª" ||
                key.toLowerCase().includes("time")
              ) {
                const date = new Date(val);
                const formattedDate = date.toLocaleDateString("ar-EG");
                const formattedTime = date.toLocaleTimeString("ar-EG", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                table += `<td class="px-4 py-2 border border-gray-300 dark:border-gray-700 text-center">${formattedDate}</td><td class="px-4 py-2 border border-gray-300 dark:border-gray-700 text-center">${formattedTime}</td>`;
              } else if (
                typeof val === "string" &&
                (val.startsWith("http://") || val.startsWith("https://")) &&
                (val.includes("drive.google.com") ||
                  val.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i))
              ) {
                table += `<td class="px-4 py-2 border border-gray-300 dark:border-gray-700 text-center text-blue-600 underline"><a href="${val}" target="_blank">ğŸ“· ${currentLang === "ar" ? "Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©" : "View Image"
                  }</a>
</td>`;
              } else {
                let translatedVal = val;

                // Ù„Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                if (translations[currentLang].tableValues?.[val]) {
                  translatedVal = translations[currentLang].tableValues[val];
                  // Ù„Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ø³Ù… ÙÙ†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø§Ø¨
                } else if (currentLang === "en") {
                  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø³Ù… Ø¨Ø¹Ø¯ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
                  if (typeof val === "string") {
                    const trimmedVal = val.trim();
                    if (techniciansMap[trimmedVal]) {
                      translatedVal = techniciansMap[trimmedVal];
                    }
                  }
                }

                table += `<td class="px-4 py-2 border border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-700 text-center">${translatedVal}</td>`;
              }
            });

            table += `</tr>`;
          });

          table += `</tbody></table></div>`;
          container.innerHTML = filters + table;
          // ğŸ§  ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          const headerCells = document.querySelectorAll(
            "#attendanceTable table thead th"
          );
          let officeColumnIndex = -1;
          headerCells.forEach((th, index) => {
            const title = th.textContent.trim();
            if (title.includes("Ø§Ù„Ù…ÙƒØªØ¨")) {
              officeColumnIndex = index;
            }
          });

          document
            .getElementById("officeFilter")
            .addEventListener("change", function () {
              const value = this.value.trim();
              const rows = document.querySelectorAll(
                "#attendanceTable table tbody tr"
              );
              rows.forEach((row) => {
                const office = row.getAttribute("data-office");
                row.style.display = !value || office === value ? "" : "none";
              });
            });

          // ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
          document
            .getElementById("searchInput")
            .addEventListener("input", function () {
              const value = this.value.trim().toLowerCase();
              const rows = document.querySelectorAll(
                "#attendanceTable table tbody tr"
              );
              rows.forEach((row) => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(value) ? "" : "none";
              });
            });
        })
        .catch((err) => {
          document.getElementById("attendanceTable").innerHTML =
            "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
          console.error("Fetch error:", err);
        });
    }

    function exportTableToCSV(filename) {
      const rows = document.querySelectorAll("#attendanceTable table tr");
      let csv = [];
      rows.forEach((row) => {
        const cols = row.querySelectorAll("td, th");
        let rowData = [];
        cols.forEach((col) => {
          rowData.push(col.innerText.replace(/,/g, "ØŒ")); // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙÙˆØ§ØµÙ„
        });
        csv.push(rowData.join(","));
      });
      const csvContent =
        "data:text/csv;charset=utf-8,\uFEFF" + csv.join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function formatDateTime(val) {
      try {
        const date = new Date(val);
        const formattedDate = date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const formattedTime = date.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        return { date: formattedDate, time: formattedTime };
      } catch (e) {
        return { date: val, time: "" };
      }
    }

    let previousData = [];

    function fetchHondaData() {
      const sheetURL =
        "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec";
      const container = document.getElementById("pageContent");
      if (previousData.length === 0) {
        container.innerHTML = `<div class='py-4'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;
      }

      fetch(sheetURL)
        .then((res) => res.json())
        .then((data) => {
          if (!data || data.length === 0) {
            console.warn("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø´ÙŠØª.");
            container.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.";
            return;
          }

          const paired = [];
          const openSites = {};

          data.forEach((row, index) => {
            const dateField = row["Date"];
            const timeField = row["Time "] || row["Time"];
            const siteID = row["Site ID"]?.trim().toLowerCase();
            const techName = row["Resource Name"]?.trim().toLowerCase();
            const action = row["Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ†"]?.trim();

            if (!dateField || !timeField || !siteID || !techName || !action) {
              console.warn(`âš ï¸ ØµÙ ${index + 1} ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©.`, row);
              return;
            }

            function convertExcelDateToJSDate(excelDate) {
              return new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            }

            let dateObj, timeObj;

            if (typeof dateField === "number") {
              dateObj = convertExcelDateToJSDate(dateField);
            } else {
              dateObj = new Date(dateField);
            }

            if (typeof timeField === "number") {
              timeObj = convertExcelDateToJSDate(timeField);
            } else {
              timeObj = new Date(timeField);
            }

            if (isNaN(dateObj.getTime()) || isNaN(timeObj.getTime())) {
              console.error(
                `âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦ Ù„Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØµÙ ${index + 1}:`,
                dateField,
                timeField
              );
              return;
            }

            const fullDateTime = new Date(
              dateObj.getFullYear(),
              dateObj.getMonth(),
              dateObj.getDate(),
              timeObj.getHours(),
              timeObj.getMinutes()
            );

            if (isNaN(fullDateTime)) {
              console.error(
                `âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦ Ù„Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØµÙ ${index + 1}:`,
                fullDateTime
              );
              return;
            }

            const date = fullDateTime.toISOString().split("T")[0]; // yyyy-mm-dd
            const time = fullDateTime
              .toTimeString()
              .split(" ")[0]
              .slice(0, 5); // hh:mm

            const key = `${siteID}-${techName}`;

            if (action === "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³ÙƒÙŠÙ†") {
              if (!openSites[key]) {
                openSites[key] = {
                  name: row["Resource Name"] || "-",
                  serial: row["PG S.N."] || "-",
                  category: row["Category"] || "-",
                  office: row["Office"] || "-",
                  siteID: row["Site ID"] || "-",
                  dateIn: date,
                  timeIn: time,
                  TT: row["ticketNumber"] || "-",
                  fuel: row["Fuel spear"] || "-",
                  startDateTime: fullDateTime,
                };
              } else {
                console.warn(
                  `âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ ØªØ³ÙƒÙŠÙ† Ù…ÙØªÙˆØ­ Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­: ${key}`
                );
              }
            } else if (action === "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³ÙƒÙŠÙ†") {
              if (openSites[key]) {
                const start = openSites[key];
                const endDateTime = fullDateTime;

                const diff = Math.abs(endDateTime - start.startDateTime);
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                const totalTime = `${hours}h ${minutes}m`;

                paired.push({
                  name: start.name,
                  serial: start.serial,
                  category: start.category,
                  office: start.office,
                  siteID: start.siteID,
                  dateIn: start.dateIn,
                  timeIn: start.timeIn,
                  dateOut: date,
                  timeOut: time,
                  totalHours: totalTime,
                  TT: start.TT,
                  fuel: start.fuel,
                });

                delete openSites[key];
              } else {
                console.warn(`âš ï¸ Ù†Ù‡Ø§ÙŠØ© ØªØ³ÙƒÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ø§ÙŠØ©: ${key}`);
              }
            }
          });

          // ğŸ” Ø¶ÙŠÙ Ø§Ù„ØªØ³ÙƒÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
          Object.values(openSites).forEach((start) => {
            paired.push({
              name: start.name,
              serial: start.serial,
              category: start.category,
              office: start.office,
              siteID: start.siteID,
              dateIn: start.dateIn,
              timeIn: start.timeIn,
              dateOut: "ğŸš«",
              timeOut: "ğŸš«",
              totalHours: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ³ÙƒÙŠÙ†",
              TT: start.TT,
              fuel: start.fuel,
            });
          });
          let downloadLabel =
            currentLang === "en" ? "â¬‡ï¸ Download Excel" : "â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Excel";
          let controls = `
  <div class="flex flex-wrap gap-2 mb-4 items-center">
    <button onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
      ${downloadLabel}
    </button>
    <input type="text" id="searchSite" placeholder="${currentLang === "en" ? "ğŸ” Search by Site ID" : "ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹"
            }" class="px-3 py-2 rounded border shadow w-48" oninput="filterTable()">
    <select id="officeFilter" onchange="filterTable()" class="px-3 py-2 rounded border shadow">
      <option value="">${currentLang === "en" ? "ğŸ¢ All Offices" : "ğŸ¢ ÙƒÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨"
            }</option>
      <option value="Gesr elsuiz">Gesr elsuiz</option>
      <option value="DownTown">DownTown</option>
      <option value="Mohandsen">Mohandsen</option>
    </select>
  </div>
`;
          // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
          let table = `
      <div class="w-full overflow-x-auto border rounded shadow min-h-[400px] h-[80vh] mt-4">
        <table class="min-w-max w-full bg-white dark:bg-gray-800 text-sm text-right border border-gray-300 dark:border-gray-700">
          <thead class="bg-pink-600 text-white sticky top-0 z-10">
            <tr>
              <th class="px-4 py-2 text-center">Resource Name</th>
              <th class="px-4 py-2 text-center">PG S.N.</th>
              <th class="px-4 py-2 text-center">Category</th>
              <th class="px-4 py-2 text-center">Office</th>
              <th class="px-4 py-2 text-center">Site ID</th>
              <th class="px-4 py-2 text-center">Date in</th>
              <th class="px-4 py-2 text-center">Time in</th>
              <th class="px-4 py-2 text-center">Date out</th>
              <th class="px-4 py-2 text-center">Time out</th>
              <th class="px-4 py-2 text-center">Total Hours</th>
              <th class="px-4 py-2 text-center">TT</th>
              <th class="px-4 py-2 text-center">Fuel spear</th>
            </tr>
          </thead>
          <tbody class="text-gray-700 dark:text-gray-200">`;
          paired.forEach((row) => {
            table += `
        <tr class="border-b hover:bg-pink-50 dark:hover:bg-gray-700">
          <td class="px-4 py-2 text-center">${row.name}</td>
          <td class="px-4 py-2 text-center">${row.serial}</td>
          <td class="px-4 py-2 text-center">${row.category}</td>
          <td class="px-4 py-2 text-center">${row.office}</td>
          <td class="px-4 py-2 text-center">${row.siteID}</td>
          <td class="px-4 py-2 text-center">${row.dateIn}</td>
          <td class="px-4 py-2 text-center">${row.timeIn}</td>
          <td class="px-4 py-2 text-center">${row.dateOut}</td>
          <td class="px-4 py-2 text-center">${row.timeOut}</td>
          <td class="px-4 py-2 text-center">${row.totalHours}</td>
          <td class="px-4 py-2 text-center">${row.TT}</td>
          <td class="px-4 py-2 text-center">${row.fuel}</td>
        </tr>`;
          });
          table += `</tbody></table></div>`;
          const newData = JSON.stringify(paired.map(JSON.stringify));
          const oldData = JSON.stringify(previousData.map(JSON.stringify));

          if (newData !== oldData) {
            container.innerHTML = controls + table;
            previousData = paired;
          } else {
            console.log("ğŸŸ¡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          }
        })
        .catch((err) => {
          container.innerHTML = "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
          console.error("Fetch Honda error:", err);
        });
    }


    function filterTable() {
      const search = document
        .getElementById("searchSite")
        .value.toLowerCase();
      const office = document
        .getElementById("officeFilter")
        .value.toLowerCase();
      const rows = document.querySelectorAll("tbody tr");

      rows.forEach((row) => {
        const siteID = row.cells[4].textContent.toLowerCase();
        const officeName = row.cells[3].textContent.toLowerCase();

        const matchesSearch = !search || siteID.includes(search);
        const matchesOffice = !office || officeName === office;

        row.style.display = matchesSearch && matchesOffice ? "" : "none";
      });
    }

    function downloadExcel() {
      const table = document.querySelector("table");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Report" });
      XLSX.writeFile(wb, "ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØªØ³ÙƒÙŠÙ†.xlsx");
    }


    function loadDashboardAnalysis() {
      const container = document.getElementById("dashboardAnalysis");
      const sheetURL = "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec";

      fetch(sheetURL)
        .then(res => res.json())
        .then(data => {
          if (!data || data.length === 0) {
            container.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ÙŠØ©.";
            return;
          }

          const siteCount = {};
          const officeCount = {};
          const hondaHours = {};
          const openSites = {};

          data.forEach(row => {
            const sn = row["PG S.N."]?.trim();
            const site = row["Site ID"]?.trim();
            const office = row["Office"]?.trim();
            const type = row["Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ†"]?.trim();
            const dateField = row["Date"];
            const timeField = row["Time "] || row["Time"];

            if (!sn || !site || !office || !type || !dateField || !timeField) return;


            function parseExcelDate(v) {
              return typeof v === "number" ? new Date(Math.round((v - 25569) * 86400 * 1000)) : new Date(v);
            }

            const dateObj = parseExcelDate(dateField);
            const timeObj = parseExcelDate(timeField);
            const fullDate = new Date(
              dateObj.getFullYear(),
              dateObj.getMonth(),
              dateObj.getDate(),
              timeObj.getHours(),
              timeObj.getMinutes()
            );

            const key = site.toLowerCase() + "-" + sn.toLowerCase();

            if (type === "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ³ÙƒÙŠÙ†") {
              openSites[key] = fullDate;
            } else if (type === "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³ÙƒÙŠÙ†" && openSites[key]) {
              const diff = fullDate - openSites[key];
              const hours = Math.floor(diff / (1000 * 60 * 60));
              const minutes = Math.floor((diff / (1000 * 60)) % 60);
              const totalMins = hours * 60 + minutes;

              hondaHours[sn] = (hondaHours[sn] || 0) + totalMins;
              siteCount[site] = (siteCount[site] || 0) + 1;
              officeCount[office] = (officeCount[office] || 0) + 1;

              delete openSites[key];
            }
          });

          function createList(obj, titleIcon, titleText, color) {
            const sorted = Object.entries(obj).sort((a, b) => b[1] - a[1]);
            let list = `<div class="bg-white rounded-2xl shadow p-4 border-t-4 border-${color}-500">
            <h3 class="text-lg font-semibold text-${color}-700 mb-2 flex items-center gap-2">
              <i class="fa-solid ${titleIcon}"></i> ${titleText}
            </h3><ul class="text-sm text-gray-700 space-y-1">`;

            sorted.slice(0, 5).forEach(([key, val]) => {
              const displayVal = titleText.includes("Ø³Ø§Ø¹Ø§Øª")
                ? `${Math.floor(val / 60)} Ø³Ø§Ø¹Ø© ${val % 60} Ø¯Ù‚ÙŠÙ‚Ø©`
                : `${val} Ù…Ø±Ø©`;
              list += `<li class="flex justify-between"><span>${key}</span><span class="font-bold">${displayVal}</span></li>`;
            });

            list += `</ul></div>`;
            return list;
          }

          let totalTaskeenMinutes = 0;
          for (const val of Object.values(hondaHours)) {
            totalTaskeenMinutes += val;
          }

          const totalHours = Math.floor(totalTaskeenMinutes / 60);
          const totalMinutes = totalTaskeenMinutes % 60;

          const html = `
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            ${createList(siteCount, "location-dot", "Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØªØ³ÙƒÙŠÙ†Ù‹Ø§", "blue")}
            ${createList(officeCount, "building", "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ³ÙƒÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØªØ¨", "green")}
            ${createList(hondaHours, "bolt", "Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ù‡ÙˆÙ†Ø¯Ø§", "pink")}
            ${createTotalCard(`${totalHours} Ø³Ø§Ø¹Ø© ${totalMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`, "clock", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ³ÙƒÙŠÙ†", "purple")}
          </div>
          
          <!-- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
  <!-- Ø¬Ø¯ÙˆÙ„ Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØªØ³ÙƒÙŠÙ†Ù‹Ø§ -->
  <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
    <h2 class="text-lg font-semibold text-gray-700 dark:text-white mb-4">Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØªØ³ÙƒÙŠÙ†Ù‹Ø§</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-right text-gray-600 dark:text-gray-200">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
            <th class="p-2">Ø§Ù„Ù…ÙƒØªØ¨</th>
            <th class="p-2">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
            <th class="p-2">Ø£ÙƒØ«Ø± Ø³Ø¨Ø¨ ØªØ³ÙƒÙŠÙ†</th>
          </tr>
        </thead>
        <tbody id="mostHousedTable">
          <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ØªØªØ¶Ø§Ù Ù‡Ù†Ø§ Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ù‡ÙˆÙ†Ø¯Ø§ -->
  <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
    <h2 class="text-lg font-semibold text-gray-700 dark:text-white mb-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ù‡ÙˆÙ†Ø¯Ø§</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-right text-gray-600 dark:text-gray-200">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
            <th class="p-2">Ø§Ù„Ù…ÙƒØªØ¨</th>
            <th class="p-2">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§</th>
            <th class="p-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="hondaHoursTable">
          <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ØªØªØ¶Ø§Ù Ù‡Ù†Ø§ Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
        </tbody>
      </table>
    </div>
  </div>
</div>
`;

          container.innerHTML = html;
        })
        .catch(err => {
          container.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.";
          console.error("Dashboard analysis error:", err);
        });
    }

    function createTotalCard(value, icon, title, color = "gray") {
      return `
    <div class="bg-white rounded-2xl shadow p-4 border-t-4 border-${color}-500">
      <h3 class="text-lg font-semibold text-${color}-700 mb-2 flex items-center gap-2">
        <i class="fa-solid fa-${icon}"></i> ${title}
      </h3>
      <div class="text-center text-xl font-bold text-gray-800">
        ${value}
      </div>
    </div>
  `;
    }

    function renderTopSitesAndReasons(data) {
  const siteMap = {};

  data.forEach(row => {
    const office = row["Ø§Ù„Ù…ÙƒØªØ¨"];
    const site = row["Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹"];
    const reason = row["Ø§Ù„Ø³Ø¨Ø¨"];

    const key = `${office}-${site}`;
    if (!siteMap[key]) {
      siteMap[key] = {
        office,
        site,
        reasons: {}
      };
    }

    siteMap[key].reasons[reason] = (siteMap[key].reasons[reason] || 0) + 1;
  });

  // Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ© ÙˆÙ†Ø±ØªØ¨Ù‡Ø§ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªØ³ÙƒÙŠÙ†
  const sortedSites = Object.values(siteMap)
    .map(entry => {
      const topReason = Object.entries(entry.reasons).sort((a, b) => b[1] - a[1])[0][0];
      return {
        office: entry.office,
        site: entry.site,
        topReason
      };
    })
    .slice(0, 10); // Ø£ÙˆÙ„ 10 Ù…ÙˆØ§Ù‚Ø¹

  const tableBody = document.getElementById("topSitesBody");
  tableBody.innerHTML = "";
  sortedSites.forEach(entry => {
    const row = `<tr>
      <td>${entry.office}</td>
      <td>${entry.site}</td>
      <td>${entry.topReason}</td>
    </tr>`;
    tableBody.innerHTML += row;
  });
}

function renderHondaHours(data) {
  const hondaMap = {};

  data.forEach(row => {
    const office = row["Ø§Ù„Ù…ÙƒØªØ¨"];
    const hondaNumber = row["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§"];
    const hours = parseFloat(row["Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„"] || "0");

    if (!hondaMap[office]) {
      hondaMap[office] = {};
    }

    hondaMap[office][hondaNumber] = (hondaMap[office][hondaNumber] || 0) + hours;
  });

  const tableBody = document.getElementById("hondaHoursBody");
  tableBody.innerHTML = "";

  Object.keys(hondaMap).forEach(office => {
    Object.entries(hondaMap[office]).forEach(([honda, totalHours]) => {
      const row = `<tr>
        <td>${office}</td>
        <td>${honda}</td>
        <td>${totalHours.toFixed(1)}</td>
      </tr>`;
      tableBody.innerHTML += row;
    });
  });
}


  </script>
</body>

</html>
